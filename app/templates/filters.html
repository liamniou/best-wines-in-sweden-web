{% extends "base.html" %}

{% block title %}Advanced Wine Filters - Best Wines Sweden{% endblock %}

{% block content %}
<!-- Compact Filters Bar -->
<div class="filter-bar bg-light py-4 border-bottom">
    <div class="container">
        <form id="wineFiltersForm">
            <div class="row g-3 align-items-end">
                <!-- Search -->
                <div class="col-md-3">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchQuery" name="q" placeholder="Wine name, producer...">
                </div>
                
                <!-- Price Range -->
                <div class="col-md-2">
                    <label class="form-label">Price (SEK)</label>
                    <div class="input-group">
                        <select class="form-select" id="minPrice" name="min_price">
                            <option value="">Min</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="150">150</option>
                            <option value="200">200</option>
                            <option value="300">300</option>
                            <option value="500">500</option>
                        </select>
                        <span class="input-group-text">-</span>
                        <select class="form-select" id="maxPrice" name="max_price">
                            <option value="">Max</option>
                            <option value="100">100</option>
                            <option value="150">150</option>
                            <option value="200">200</option>
                            <option value="300">300</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                </div>
                
                <!-- Wine Style -->
                <div class="col-md-2">
                    <label class="form-label">Style</label>
                    <select class="form-select" id="simplifiedWineStyle" name="simplified_wine_style">
                        <option value="">All Styles</option>
                        <option value="Red Wine">Red Wine</option>
                        <option value="White Wine">White Wine</option>
                        <option value="RosÃ© Wine">RosÃ© Wine</option>
                        <option value="Sparkling Wine">Sparkling</option>
                        <option value="Dessert Wine">Dessert</option>
                        <option value="Fortified Wine">Fortified</option>
                    </select>
                </div>
                
                <!-- Country -->
                <div class="col-md-2">
                    <label class="form-label">Country</label>
                    <select class="form-select" id="vivinoCountry" name="vivino_country">
                        <option value="">All Countries</option>
                        {% for country in filter_options.vivino_countries %}
                        <option value="{{ country }}">{{ country }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Sort -->
                <div class="col-md-2">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" id="sortBy" name="sort_by">
                        <option value="match_score_desc">Best Match</option>
                        <option value="rating_desc">Highest Rating</option>
                        <option value="price_asc">Price: Lowâ†’High</option>
                        <option value="price_desc">Price: Highâ†’Low</option>
                        <option value="date_desc">Newest</option>
                    </select>
                </div>
                
                <!-- Actions -->
                <div class="col-md-1">
                    <div class="d-flex gap-1">
                        <button type="submit" class="btn btn-primary" title="Search">
                            <i class="bi bi-search"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearAllFilters()" title="Clear All">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Results Section -->
<div class="container py-5" id="resultsSection" style="display: none;">
    <div class="results-header mb-4">
        <h3>Search Results</h3>
        <p class="text-muted" id="resultsCount">0 wines found</p>
    </div>
    
    <div id="wineGrid" class="row">
        <!-- Wine results will be loaded here -->
    </div>
    
    <div class="text-center mt-4">
        <button id="loadMoreBtn" class="btn btn-outline-primary" style="display: none;" onclick="handleLoadMore()">
            <i class="bi bi-arrow-down"></i> Load More Results
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Use global variables from main.js
window.allWines = [];
window.winesLoaded = false;

// Load all wines on page load for client-side filtering
async function loadAllWines() {
    try {
        const response = await fetch('/api/wines');
        window.allWines = await response.json();
        window.winesLoaded = true;
        console.log(`Loaded ${window.allWines.length} wines for filtering`);
        return window.allWines;
    } catch (error) {
        console.error('Error loading wines:', error);
        window.winesLoaded = true;
        return [];
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    // Load wines first, then process URL params
    await loadAllWines();
    
    // Read URL parameters and apply them
    const urlParams = new URLSearchParams(window.location.search);
    const sortParam = urlParams.get('sort');
    const searchParam = urlParams.get('q');
    
    if (sortParam) {
        const sortSelect = document.getElementById('sortBy');
        if (sortSelect) {
            const option = sortSelect.querySelector(`option[value="${sortParam}"]`);
            if (option) {
                sortSelect.value = sortParam;
            }
        }
    }
    
    if (searchParam) {
        const searchInput = document.getElementById('searchQuery');
        if (searchInput) {
            searchInput.value = searchParam;
        }
    }
    
    // Auto-submit the form if any URL params are present
    if (sortParam || searchParam) {
        searchWinesWithForm();
    }
    
    // Form submission
    document.getElementById('wineFiltersForm').addEventListener('submit', function(e) {
        e.preventDefault();
        searchWinesWithForm();
    });
    
});

// Global load more handler (also attached via onclick)
function handleLoadMore() {
    console.log('handleLoadMore called, current page:', window.currentPage);
    console.log('isLoading:', window.isLoading);
    console.log('allWines count:', window.allWines ? window.allWines.length : 0);
    
    window.currentPage = (window.currentPage || 1) + 1;
    console.log('New page:', window.currentPage);
    searchWinesWithForm(true);
}

async function searchWinesWithForm(append = false) {
    console.log('searchWinesWithForm called with append:', append);
    
    if (window.isLoading) {
        console.log('Already loading, skipping');
        return;
    }
    
    window.isLoading = true;
    
    try {
    const form = document.getElementById('wineFiltersForm');
    const formData = new FormData(form);
    
    // Get filter values
    const minPrice = parseFloat(formData.get('min_price')) || 0;
    const maxPrice = parseFloat(formData.get('max_price')) || Infinity;
    const wineStyle = formData.get('simplified_wine_style') || '';
    const country = formData.get('vivino_country') || '';
    const foodPairing = formData.get('food_pairing') || '';
    const searchQuery = (formData.get('q') || '').toLowerCase().trim();
    const sortOption = formData.get('sort_by') || 'match_score_desc';
    
    // Wine style mappings (English to Swedish)
    const styleMap = {
        'Red Wine': ['Red Wine', 'RÃ¶tt vin', 'rÃ¶tt vin'],
        'White Wine': ['White Wine', 'Vitt vin', 'vitt vin'],
        'RosÃ© Wine': ['RosÃ© Wine', 'RosÃ©vin', 'rosÃ©vin'],
        'Sparkling Wine': ['Sparkling Wine', 'Mousserande vin', 'mousserande vin'],
        'Dessert Wine': ['Dessert Wine', 'Dessertvin', 'dessertvin'],
        'Fortified Wine': ['Fortified Wine', 'Starkvin', 'starkvin']
    };
    
    // Filter wines client-side
    let filteredWines = window.allWines.filter(wine => {
        // Search query filter
        if (searchQuery) {
            const searchableText = [
                wine.systembolaget_name,
                wine.vivino_name,
                wine.vivino_winery,
                wine.producer,
                wine.vivino_country,
                wine.country
            ].filter(Boolean).join(' ').toLowerCase();
            
            if (!searchableText.includes(searchQuery)) return false;
        }
        
        const price = wine.price || 0;
        if (price < minPrice || price > maxPrice) return false;
        
        // Check wine style with Swedish translation support
        if (wineStyle) {
            const wineStyleVal = wine.vivino_wine_style || wine.wine_style || '';
            const acceptedStyles = styleMap[wineStyle] || [wineStyle];
            if (!acceptedStyles.some(s => s.toLowerCase() === wineStyleVal.toLowerCase())) return false;
        }
        
        if (country && wine.vivino_country !== country && wine.country !== country) return false;
        if (foodPairing && wine.simplified_food_pairings) {
            const pairings = Array.isArray(wine.simplified_food_pairings) 
                ? wine.simplified_food_pairings 
                : [];
            if (!pairings.some(p => p.toLowerCase() === foodPairing.toLowerCase())) return false;
        }
        return true;
    });
    
    // Sort wines
    const [sortField, sortDir] = sortOption.split('_');
    filteredWines.sort((a, b) => {
        let aVal, bVal;
        if (sortField === 'price') {
            aVal = a.price || 0;
            bVal = b.price || 0;
        } else if (sortField === 'rating') {
            aVal = a.vivino_rating || 0;
            bVal = b.vivino_rating || 0;
        } else if (sortField === 'date') {
            // Sort by updated_at timestamp (newest first)
            aVal = new Date(a.updated_at || 0).getTime();
            bVal = new Date(b.updated_at || 0).getTime();
        } else {
            aVal = a.match_score || 0;
            bVal = b.match_score || 0;
        }
        return sortDir === 'asc' ? aVal - bVal : bVal - aVal;
    });
    
    // Pagination
    const pageSize = 20;
    if (!append) {
        window.currentPage = 1;
    }
    const currentPageValue = window.currentPage || 1;
    const startIdx = (currentPageValue - 1) * pageSize;
    const wines = filteredWines.slice(startIdx, startIdx + pageSize);
    const totalFiltered = filteredWines.length;
    const hasMore = startIdx + wines.length < totalFiltered;
    
    console.log('Pagination:', { append, currentPageValue, startIdx, winesOnPage: wines.length, totalFiltered, hasMore });
    
    // Store filtered wines for load more
    window.lastFilteredWines = filteredWines;
    
    const resultsSection = document.getElementById('resultsSection');
    const wineGrid = document.getElementById('wineGrid');
    const resultsCount = document.getElementById('resultsCount');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
        
        if (!append) {
            wineGrid.innerHTML = '';
        }
        
        // Display results
        resultsSection.style.display = 'block';
        
        if (wines.length > 0) {
            wines.forEach(wine => {
                const wineCard = createWineCard(wine);
                wineGrid.appendChild(wineCard);
            });
            
            // Update results count - show displayed / total
            const displayedCount = document.querySelectorAll('#wineGrid .col-lg-6').length;
            resultsCount.textContent = `${displayedCount} of ${totalFiltered} wines`;
            
            // Show/hide load more button based on remaining wines
            loadMoreBtn.style.display = hasMore ? 'block' : 'none';
        } else {
            if (!append) {
                wineGrid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                        <h4 class="text-muted mt-3">No wines found</h4>
                        <p class="text-muted">Try adjusting your filters to find more wines.</p>
                    </div>
                `;
                resultsCount.textContent = '0 wines found';
            }
            loadMoreBtn.style.display = 'none';
        }
        
        // Scroll to results if not appending
        if (!append) {
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
    } catch (error) {
        console.error('Search error:', error);
        alert('Error searching wines. Please try again.');
    } finally {
        window.isLoading = false;
        console.log('isLoading reset to false');
    }
}

function createWineCard(wine) {
    // Reuse the existing createWineCard function from main.js
    // This will be the same function that creates wine cards on other pages
    const div = document.createElement('div');
    div.className = 'col-lg-6 col-xl-4 mb-4';
    
    // Color-coded match percentage badge
    let matchBadge = '';
    if (wine.match_score) {
        const matchClass = wine.match_score >= 80 ? 'bg-success' : wine.match_score >= 50 ? 'bg-warning text-dark' : 'bg-danger';
        matchBadge = `<span class="badge ms-1 ${matchClass}">${Math.round(wine.match_score)}% match</span>`;
    }
    
    const price = wine.price ? `${Math.round(wine.price)} SEK` : 'Price N/A';
    
    // Enhanced wine information - compact layout
    const rawStyle = wine.vivino_wine_style || wine.wine_style || '';
    const styleLower = rawStyle.toLowerCase();
    
    // Translate Swedish wine styles to English for display
    const styleTranslations = {
        'rÃ¶tt vin': 'Red Wine',
        'vitt vin': 'White Wine', 
        'rosÃ©vin': 'RosÃ© Wine',
        'mousserande vin': 'Sparkling Wine',
        'dessertvin': 'Dessert Wine',
        'starkvin': 'Fortified Wine'
    };
    const style = styleTranslations[styleLower] || rawStyle;
    
    const styleClass = styleLower.includes('red') || styleLower.includes('rÃ¶tt') ? 'wine-style-red' :
                       styleLower.includes('white') || styleLower.includes('vitt') ? 'wine-style-white' :
                       styleLower.includes('rosÃ©') || styleLower.includes('rose') || styleLower.includes('rosÃ©') ? 'wine-style-rose' :
                       styleLower.includes('sparkling') || styleLower.includes('champagne') || styleLower.includes('prosecco') || styleLower.includes('mousserande') ? 'wine-style-sparkling' :
                       styleLower.includes('dessert') || styleLower.includes('sweet') || styleLower.includes('dessertvin') ? 'wine-style-dessert' :
                       styleLower.includes('fortified') || styleLower.includes('port') || styleLower.includes('sherry') || styleLower.includes('starkvin') ? 'wine-style-fortified' :
                       'wine-style-other';
    const vivinoWineStyle = style ? `<span class="badge ${styleClass}">${style}</span>` : '';
    const year = wine.year ? `<span class="badge bg-outline-secondary me-1">${wine.year}</span>` : '';
    
    // Country emoji badge
    const country = wine.vivino_country || wine.country || '';
    const countryEmojis = {
        'spain': 'ğŸ‡ªğŸ‡¸', 'spanien': 'ğŸ‡ªğŸ‡¸',
        'france': 'ğŸ‡«ğŸ‡·', 'frankrike': 'ğŸ‡«ğŸ‡·',
        'italy': 'ğŸ‡®ğŸ‡¹', 'italien': 'ğŸ‡®ğŸ‡¹',
        'germany': 'ğŸ‡©ğŸ‡ª', 'tyskland': 'ğŸ‡©ğŸ‡ª',
        'portugal': 'ğŸ‡µğŸ‡¹',
        'australia': 'ğŸ‡¦ğŸ‡º', 'australien': 'ğŸ‡¦ğŸ‡º',
        'chile': 'ğŸ‡¨ğŸ‡±',
        'argentina': 'ğŸ‡¦ğŸ‡·',
        'usa': 'ğŸ‡ºğŸ‡¸', 'united states': 'ğŸ‡ºğŸ‡¸',
        'south africa': 'ğŸ‡¿ğŸ‡¦', 'sydafrika': 'ğŸ‡¿ğŸ‡¦',
        'new zealand': 'ğŸ‡³ğŸ‡¿', 'nya zeeland': 'ğŸ‡³ğŸ‡¿',
        'austria': 'ğŸ‡¦ğŸ‡¹', 'Ã¶sterrike': 'ğŸ‡¦ğŸ‡¹',
        'greece': 'ğŸ‡¬ğŸ‡·', 'grekland': 'ğŸ‡¬ğŸ‡·',
        'lebanon': 'ğŸ‡±ğŸ‡§', 'libanon': 'ğŸ‡±ğŸ‡§',
        'north macedonia': 'ğŸ‡²ğŸ‡°', 'nordmakedonien': 'ğŸ‡²ğŸ‡°'
    };
    const countryLower = country.toLowerCase();
    let countryEmoji = 'ğŸŒ';
    for (const [key, emoji] of Object.entries(countryEmojis)) {
        if (countryLower.includes(key)) {
            countryEmoji = emoji;
            break;
        }
    }
    const countryBadge = country ? `<span class="badge bg-light text-dark" title="${country}">${countryEmoji}</span>` : '';
    
    // Compact meta line
    const wineryName = wine.vivino_winery || wine.producer;
    const alcoholContent = wine.vivino_alcohol_content || wine.alcohol_percentage;
    
    let metaParts = [];
    if (country) metaParts.push(`<span class="me-2"><i class="bi bi-geo-alt"></i> ${country}</span>`);
    if (wineryName) metaParts.push(`<span class="me-2"><i class="bi bi-house"></i> ${wineryName}</span>`);
    if (alcoholContent) metaParts.push(`<span><i class="bi bi-percent"></i> ${alcoholContent}%</span>`);
    const wineMeta = metaParts.length > 0 ? `<div class="wine-meta text-muted small mb-2">${metaParts.join('')}</div>` : '';
    
    // Food pairings - emoji + text badges
    let foodPairingsHtml = '';
    if (wine.simplified_food_pairings && wine.simplified_food_pairings.length > 0) {
        const pairingEmojis = {
            'beef': 'ğŸ¥©', 'pork': 'ğŸ¥“', 'lamb': 'ğŸ‘', 'game': 'ğŸ¦Œ',
            'poultry': 'ğŸ”', 'chicken': 'ğŸ”', 'duck': 'ğŸ¦†',
            'fish': 'ğŸŸ', 'shellfish': 'ğŸ¦', 'seafood': 'ğŸ¦',
            'cheese': 'ğŸ§€', 'vegetables': 'ğŸ¥¬', 'vegetarian': 'ğŸ¥¬', 'pasta': 'ğŸ',
            'appetizer': 'ğŸ¥‚', 'appetizers': 'ğŸ¥‚', 'dessert': 'ğŸ°', 'desserts': 'ğŸ°',
            'chocolate': 'ğŸ«', 'nuts': 'ğŸ¥œ'
        };
        foodPairingsHtml = wine.simplified_food_pairings.slice(0, 4).map(p => {
            const emoji = pairingEmojis[p.toLowerCase()] || 'ğŸ½ï¸';
            const label = p.charAt(0).toUpperCase() + p.slice(1).toLowerCase();
            return `<span class="badge bg-light text-dark me-1">${emoji} ${label}</span>`;
        }).join('');
    }
    
    // Wine characteristics
    const characteristics = [];
    if (wine.body) {
        const bodyText = wine.body <= 2 ? 'Light' : wine.body <= 3 ? 'Medium' : 'Full';
        characteristics.push(`<span class="badge bg-info me-1"><i class="bi bi-droplet"></i> ${bodyText} Body</span>`);
    }
    if (wine.acidity) {
        const acidityText = wine.acidity <= 2 ? 'Low' : wine.acidity <= 3 ? 'Medium' : 'High';
        characteristics.push(`<span class="badge bg-warning text-dark me-1"><i class="bi bi-lightning"></i> ${acidityText} Acidity</span>`);
    }
    if (wine.sweetness) {
        const sweetnessText = wine.sweetness <= 1 ? 'Bone Dry' : wine.sweetness <= 2 ? 'Dry' : wine.sweetness <= 3 ? 'Off-Dry' : wine.sweetness <= 4 ? 'Medium Sweet' : 'Sweet';
        characteristics.push(`<span class="badge bg-danger text-white me-1"><i class="bi bi-heart"></i> ${sweetnessText}</span>`);
    }
    const characteristicsHtml = characteristics.length > 0 ? `<div class="mb-2">${characteristics.join('')}</div>` : '';
    
    // Match score is already in header badge, no need to duplicate
    
    // Wine image with fallback
    const wineImage = wine.image_url ? 
        `<div class="wine-image-container text-center py-3">
            <img src="${wine.image_url}" 
                 alt="${wine.vivino_name}" 
                 class="wine-bottle-image img-fluid"
                 style="max-height: 200px; max-width: 120px; object-fit: contain;"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="wine-placeholder d-none text-muted">
                <i class="bi bi-cup" style="font-size: 3rem;"></i>
                <br><small>No image available</small>
            </div>
         </div>` : 
        `<div class="wine-image-container text-center py-3">
            <div class="wine-placeholder text-muted">
                <i class="bi bi-cup" style="font-size: 3rem;"></i>
                <br><small>No image available</small>
            </div>
         </div>`;
    
    div.innerHTML = `
        <div class="wine-card card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-1">
                    <span class="badge ${wine.vivino_rating ? 'bg-warning text-dark' : 'bg-secondary'}"><i class="bi bi-star-fill"></i> ${wine.vivino_rating || 'N/A'}</span>
                    ${vivinoWineStyle ? `<span>${vivinoWineStyle}</span>` : ''}
                    ${countryBadge}
                </div>
                <span class="badge bg-dark">${price}</span>
            </div>
            
            ${wineImage}
            
            <div class="card-body">
                <div class="wine-title-container ${wine.match_score >= 80 ? 'match-high' : wine.match_score >= 50 ? 'match-medium' : 'match-low'}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <p class="card-title fw-bold mb-1 fs-6">${wine.systembolaget_name}</p>
                            ${wine.vivino_name && wine.vivino_name !== wine.systembolaget_name ? `<p class="text-muted mb-0 fst-italic fs-6">${wine.vivino_name}</p>` : ''}
                        </div>
                        ${wine.match_score ? `<span class="badge ${wine.match_score >= 80 ? 'bg-success' : wine.match_score >= 50 ? 'bg-warning text-dark' : 'bg-danger'} ms-2">${Math.round(wine.match_score)}%</span>` : ''}
                    </div>
                </div>
            </div>
            
            <div class="card-footer bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="/wine/${wine.match_id}" class="btn btn-primary btn-sm">
                        <i class="bi bi-eye"></i> Details
                    </a>
                    <a href="https://systembolaget.se/sortiment/vin/?q=${wine.product_number}" 
                       target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-cart"></i> Buy
                    </a>
                </div>
            </div>
        </div>
    `;
    
    return div;
}

function clearAllFilters() {
    document.getElementById('wineFiltersForm').reset();
    document.getElementById('resultsSection').style.display = 'none';
    window.currentPage = 1;
}

// Price range dropdown validation
document.addEventListener('DOMContentLoaded', function() {
    const minPriceSelect = document.getElementById('minPrice');
    const maxPriceSelect = document.getElementById('maxPrice');
    
    function validatePriceRange() {
        const minVal = parseInt(minPriceSelect.value) || 0;
        const maxVal = parseInt(maxPriceSelect.value) || 999999;
        
        // If user selects a min price that's higher than max price, clear max price
        if (minVal > maxVal && maxPriceSelect.value !== '') {
            // Only warn if both values are selected
            if (minPriceSelect.value !== '' && maxPriceSelect.value !== '') {
                // You could add a visual warning here if needed
                console.log('Min price cannot be higher than max price');
            }
        }
    }
    
    minPriceSelect.addEventListener('change', validatePriceRange);
    maxPriceSelect.addEventListener('change', validatePriceRange);
});
</script>

<style>
.filter-bar {
    background: var(--bg-secondary, #f8fafc);
    border-bottom: 1px solid var(--border-default, #e2e8f0);
}

.filter-bar .form-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--text-secondary, #64748b);
    margin-bottom: 0.25rem;
}

/* Normalize all form control heights in filter bar */
.filter-bar .form-select,
.filter-bar .form-control,
.filter-bar .input-group-text,
.filter-bar .btn {
    height: 38px;
    padding-top: 0.375rem;
    padding-bottom: 0.375rem;
}

.filter-bar .input-group .form-select {
    height: 38px;
}

.results-header {
    border-bottom: 2px solid var(--primary, #722f37);
    padding-bottom: 1rem;
}
</style>
{% endblock %}